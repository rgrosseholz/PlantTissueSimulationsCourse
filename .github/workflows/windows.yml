name: VirtualLeaf compile clean and package for windows
run-name: ${{ github.actor }} is testing on windows
on:
  push:
    branches:
      - main
  pull_request:
  release:
    types: [created]

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '5.15.2'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_mingw81'
          tools: 'tools_mingw,qt.tools.win64_mingw810'

      - name: Add MinGW to PATH
        run: |
          echo "$env:IQTA_TOOLS\mingw810_64\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          echo "PATH updated"
        shell: pwsh

      - name: Verify MinGW installation
        run: |
          echo "Current PATH: $env:PATH"
          echo "IQTA_TOOLS: $env:IQTA_TOOLS"
          where.exe g++
          g++ --version
          mingw32-make --version
          qmake --version

      - name: Build Project
        run: |
          $env:PATH = "$env:IQTA_TOOLS\mingw810_64\bin;$env:PATH"
          cd src
          qmake VirtualLeaf.pro
          mingw32-make
        shell: pwsh

      - name: Package Project
        uses: actions/upload-artifact@v4
        with:
          name: VirtualLeaf-windows-x64
          path: |
            ${{ github.workspace }}/bin/**/*
            ${{ github.workspace }}/data/**/*

  release:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'release' && github.event.action == 'created'
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - uses: actions/download-artifact@v4

      - name: Display structure of downloaded files
        run: ls -R ${{ github.workspace }}

      - name: 'ðŸ“¦ Package windows x64'
        run: |
          zip -r VirtualLeaf-windows-x64.zip VirtualLeaf-windows-x64
          gh release upload ${{ github.event.release.tag_name }} VirtualLeaf-windows-x64.zip
        env:
          GITHUB_TOKEN: ${{ github.token }}
        shell: bash
